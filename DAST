#!/usr/bin/env python3
"""
OWASP ZAP DAST Security Gate
- Runs spider + active scan
- Fails pipeline on High / Critical alerts
"""

import time
import sys
from zapv2 import ZAPv2

# ================= CONFIG =================

ZAP_API_KEY = "SECUREKEY123"
ZAP_URL = "http://127.0.0.1:8090"
TARGET = "http://example.com"   # ⬅️ change to your app URL

FAIL_ON_RISK = {"High", "Critical"}

# =========================================


def wait_for_zap(zap):
    try:
        version = zap.core.version
        print(f"[+] ZAP ready (version {version})")
    except Exception as e:
        print("[-] ZAP not reachable")
        print(e)
        sys.exit(2)


def run_spider(zap, target):
    print("[*] Starting spider scan...")
    scan_id = zap.spider.scan(target)
    time.sleep(2)

    while int(zap.spider.status(scan_id)) < 100:
        print(f"    Spider progress: {zap.spider.status(scan_id)}%")
        time.sleep(2)

    print("[+] Spider completed")


def run_active_scan(zap, target):
    print("[*] Starting active scan...")
    scan_id = zap.ascan.scan(target)
    time.sleep(5)

    while int(zap.ascan.status(scan_id)) < 100:
        print(f"    Active scan progress: {zap.ascan.status(scan_id)}%")
        time.sleep(5)

    print("[+] Active scan completed")


def evaluate_alerts(zap, target):
    print("[*] Evaluating alerts...")
    alerts = zap.core.alerts(baseurl=target)

    failed = False
    risk_count = {}

    for alert in alerts:
        risk = alert.get("risk")
        risk_count[risk] = risk_count.get(risk, 0) + 1

        if risk in FAIL_ON_RISK:
            failed = True
            print(f"[-] {risk} : {alert.get('alert')}")

    print("\n[*] Alert summary:")
    for risk, count in risk_count.items():
        print(f"    {risk}: {count}")

    return failed


def main():
    zap = ZAPv2(apikey=ZAP_API_KEY, proxies={"http": ZAP_URL, "https": ZAP_URL})

    wait_for_zap(zap)

    zap.core.access_url(TARGET)
    time.sleep(2)

    run_spider(zap, TARGET)
    run_active_scan(zap, TARGET)

    failed = evaluate_alerts(zap, TARGET)

    if failed:
        print("\n❌ SECURITY GATE FAILED (High/Critical found)")
        sys.exit(1)
    else:
        print("\n✅ SECURITY GATE PASSED")
        sys.exit(0)


if __name__ == "__main__":
    main()
